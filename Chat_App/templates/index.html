<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat en tiempo real</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      #chat {
        height: 400px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
      }
      .message {
        margin-bottom: 10px;
      }
      .message.right {
        text-align: right;
      }
      .message.left {
        text-align: left;
      }
      .username {
        font-weight: bold;
      }
      .typing-notification {
        font-style: italic;
        color: #888;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="card">
        <div class="card-header bg-primary text-white">Chat en tiempo real</div>
        <div class="card-body">
          <!-- Área del chat -->
          <div id="chat" class="mb-3">
            <ul id="messages" class="list-unstyled"></ul>
            <div id="typing-notification" class="typing-notification"></div>
          </div>

          <!-- Entrada de nombre de usuario -->
          <div class="input-group mb-3">
            <input
              id="username"
              type="text"
              class="form-control"
              placeholder="Tu nombre"
              required
            />
          </div>

          <!-- Entrada de mensaje -->
          <div class="input-group">
            <input
              id="myMessage"
              type="text"
              class="form-control"
              placeholder="Escribe un mensaje..."
              disabled
            />
            <button onclick="sendMessage()" class="btn btn-primary">
              Enviar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
      var socket = io.connect(
        "http://" + document.domain + ":" + location.port
      );
      var username = null;

      // Unirse al chat
      document
        .getElementById("username")
        .addEventListener("change", function () {
          username = this.value;
          if (username.trim() !== "") {
            socket.emit("join", username);
            document.getElementById("myMessage").disabled = false;
            this.disabled = true;
          }
        });

      // Enviar mensaje al presionar Enter
      document
        .getElementById("myMessage")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

      // Notificar que el usuario está escribiendo
      document
        .getElementById("myMessage")
        .addEventListener("input", function () {
          if (username) {
            socket.emit("typing", username);
          }
        });

      // Recibir mensajes
      socket.on("message", function (data) {
        if (data.type === "message") {
          var li = document.createElement("li");
          li.className =
            "message " + (data.username === username ? "right" : "left");
          li.innerHTML = `<span class="username" style="color: ${data.color}">${data.username}:</span> ${data.message}`;
          document.getElementById("messages").appendChild(li);
          document.getElementById("chat").scrollTop =
            document.getElementById("chat").scrollHeight;
        }
      });

      // Recibir notificaciones
      socket.on("notification", function (data) {
        if (data.type === "notification") {
          var li = document.createElement("li");
          li.className = "notification";
          li.innerHTML = `<span class="typing-notification">${data.message}</span>`;
          document.getElementById("messages").appendChild(li);
          document.getElementById("chat").scrollTop =
            document.getElementById("chat").scrollHeight;
        }
      });

      // Recibir notificación de que alguien está escribiendo
      socket.on("typing", function (data) {
        if (data.type === "typing") {
          var typingNotification = document.getElementById(
            "typing-notification"
          );
          typingNotification.innerText = `${data.username} está escribiendo...`;
          setTimeout(function () {
            typingNotification.innerText = "";
          }, 3000); // Limpiar la notificación después de 3 segundos
        }
      });

      // Recuperar mensajes antiguos
      socket.on("old_messages", function (messages) {
        messages.forEach(function (msg) {
          var li = document.createElement("li");
          li.className =
            "message " + (msg.username === username ? "right" : "left");
          li.innerHTML = `<span class="username" style="color: ${msg.color}">${msg.username}:</span> ${msg.message}`;
          document.getElementById("messages").appendChild(li);
        });
        document.getElementById("chat").scrollTop =
          document.getElementById("chat").scrollHeight;
      });

      // Función para enviar mensajes
      function sendMessage() {
        var message = document.getElementById("myMessage").value;
        if (message.trim() !== "") {
          socket.emit("message", { username: username, message: message });
          document.getElementById("myMessage").value = "";
        }
      }
    </script>
  </body>
</html>
